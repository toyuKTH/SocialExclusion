// å¯åŠ¨ SuperCollider æœåŠ¡å™¨
// (
// s.waitForBoot({
// 	b = Buffer.read(s, "C:/Users/Think/Desktop/background.wav");
	/*b = Buffer.read(s, Platform.resourceDir +/+ "sounds/a11wlk01.wav");*/

(
s.waitForBoot({
    // âœ… ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
    var path = "E:\backgroud.wav";
    if (File.exists(path), {
        b = Buffer.read(s, path);
        s.sync;
        "âœ… Buffer åŠ è½½æˆåŠŸ".postln;


		(
            Ndef(\drops, { |bufnum=0, rate=1, amp=0.5|
                PlayBuf.ar(1, bufnum, rate, loop: 1, doneAction: Done.freeSelf) * amp ! 2
            }).set(\bufnum, b.bufnum).play;
            Ndef(\drops).fadeTime = 3;
        );


    }, {
        "âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„".postln;
    });

    // ğŸµ å®šä¹‰å·´æ¾ï¼ˆBassoonï¼‰åˆæˆå™¨
    SynthDef(\bassoon, { |freq = 440, amp = 0.3, dur = 2|
        var env = EnvGen.kr(Env.perc(0.1, dur), doneAction: 2);
        var sound = VarSaw.ar(freq, 0, 0.4) * env * amp;
        Out.ar(0, sound);
    }).add;

    // ğŸº å®šä¹‰å°å·ï¼ˆTrumpetï¼‰åˆæˆå™¨
    SynthDef(\trumpet, { |freq = 440, amp = 0.3, dur = 2|
        var env = EnvGen.kr(Env.perc(0.05, dur), doneAction: 2);
        var sound = Saw.ar(freq) * env * amp;
        Out.ar(0, sound);
    }).add;
	(
		Ndef(\drops, { |bufnum=0, rate=1, amp=0.5|
			PlayBuf.ar(1, bufnum, rate, loop: 1, doneAction: Done.freeSelf) * amp ! 2 }).set(\bufnum, b.bufnum).play;
		Ndef(\drops).fadeTime = 3;
	);
    // ğŸ§ ç›‘å¬ WebSocket æœåŠ¡å™¨å‘é€çš„ OSC æ¶ˆæ¯
    OSCdef(\country_info, { |msg|
        var group = msg[1].asSymbol;  // è§£æç¾¤ä½“ (total, male, female)
        var value = msg[2].asFloat;   // è§£ææ•°å€¼
        var freq = value * 15;        // è®¡ç®—é¢‘ç‡
		var volume = -1 * value;
		value.postln;
		volume.dbamp.postln;
		Ndef(\drops).set(\amp, volume.dbamp);

        // âœ… ç¡®ä¿é¢‘ç‡æœ‰æ•ˆï¼Œé¿å…æ’­æ”¾é”™è¯¯
        if (freq.isNaN or: { freq <= 0 }) {
            freq = 440; // é»˜è®¤é¢‘ç‡ A4
        };

        // ğŸ¼ é€‰æ‹©ä¹å™¨æ’­æ”¾
        if (group == \total) {
            Synth(\bassoon, [\freq, freq]);
            Synth(\trumpet, [\freq, freq]);
            ("ğŸµ æ’­æ”¾å·´æ¾ & å°å·ï¼Œé¢‘ç‡: " ++ freq).postln;
        } {
            if (group == \female) {
                Synth(\trumpet, [\freq, freq]);
                ("ğŸº ä»…æ’­æ”¾å°å·ï¼Œé¢‘ç‡: " ++ freq).postln;
            } {
                if (group == \male) {
                    Synth(\bassoon, [\freq, freq]);
                    ("ğŸ» ä»…æ’­æ”¾å·´æ¾ï¼Œé¢‘ç‡: " ++ freq).postln;
                };
            };
        };

    }, '/country_info');






	 // âœ… ç›‘å¬ OSC æ¶ˆæ¯ï¼Œæ§åˆ¶èƒŒæ™¯éŸ³ä¹æ’­æ”¾/åœæ­¢
   OSCdef(\background_control, { |msg|
    var command = msg[1].asSymbol;
    command.postln;  // æ‰“å°æ”¶åˆ°çš„å‘½ä»¤

    if (command == \play) {
        "â–¶ï¸ é‡æ–°æ’­æ”¾èƒŒæ™¯éŸ³ä¹".postln;
        Ndef(\drops).clear; // æ¸…é™¤ä¹‹å‰çš„ Ndefï¼Œç¡®ä¿å¯ä»¥é‡æ–°å¯åŠ¨
        Ndef(\drops, { |bufnum=0, rate=1, amp=0.5|
            PlayBuf.ar(1, bufnum, rate, loop: 1, doneAction: Done.freeSelf) * amp ! 2;
        }).set(\bufnum, b.bufnum).play;
    } {
        if (command == \stop) {
            "â¹ åœæ­¢èƒŒæ™¯éŸ³ä¹".postln;
            Ndef(\drops).stop;
            Ndef(\drops).clear; // é‡Šæ”¾èµ„æºï¼Œç¡®ä¿ä¸‹æ¬¡ `play` èƒ½é‡æ–°åˆ›å»º
        };
    };
}, '/background_control');

    "âœ… SuperCollider æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç­‰å¾… OSC æ¶ˆæ¯...".postln;

});
)

/*b = Buffer.read(s, Platform.resourceDir +/+ "sounds/a11wlk01.wav");*/


